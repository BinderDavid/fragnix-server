{"sliceID":2708884142443134907,"uses":[{"reference":{"otherSlice":3244558403807755735},"usedName":{"constructorName":{"identifier":"Context"},"constructorTypeName":{"identifier":"Context"}},"qualification":null},{"reference":{"otherSlice":3244558403807755735},"usedName":{"valueName":{"identifier":"outputQ"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"constructorName":{"identifier":"ResponseStream"},"constructorTypeName":{"identifier":"Response"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"identifier":"otherwise"}},"qualification":null},{"reference":{"otherSlice":5440180208492924562},"usedName":{"valueName":{"identifier":"getHTTP2Data"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":">>="}},"qualification":null},{"reference":{"otherSlice":8575358489457556274},"usedName":{"valueName":{"identifier":"pushStream"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"constructorName":{"identifier":"ResponseBuilder"},"constructorTypeName":{"identifier":"Response"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"constructorName":{"identifier":"ResponseFile"},"constructorTypeName":{"identifier":"Response"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"constructorName":{"identifier":"ResponseRaw"},"constructorTypeName":{"identifier":"Response"}},"qualification":null},{"reference":{"builtinModule":"GHC.Err"},"usedName":{"valueName":{"identifier":"error"}},"qualification":null},{"reference":{"builtinModule":"GHC.Classes"},"usedName":{"valueName":{"identifier":"not"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":"."}},"qualification":null},{"reference":{"otherSlice":428493621648958047},"usedName":{"valueName":{"identifier":"hasBody"}},"qualification":"R"},{"reference":{"otherSlice":2150836866812832620},"usedName":{"valueName":{"identifier":"requestMethod"}},"qualification":null},{"reference":{"builtinModule":"GHC.Classes"},"usedName":{"valueName":{"operator":"=="}},"qualification":null},{"reference":{"otherSlice":3741126862016059343},"usedName":{"valueName":{"identifier":"methodHead"}},"qualification":"H"},{"reference":{"otherSlice":7471038449729235448},"usedName":{"valueName":{"identifier":"settingsLogger"}},"qualification":"S"},{"reference":{"otherSlice":27681834806193008},"usedName":{"valueName":{"identifier":"threadHandle"}},"qualification":null},{"reference":{"otherSlice":686719806749404538},"usedName":{"valueName":{"identifier":"streamNumber"}},"qualification":null},{"reference":{"otherSlice":866162753350440556},"usedName":{"valueName":{"identifier":"toHeaderTable"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"constructorName":{"identifier":"Nothing"},"constructorTypeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"otherSlice":2807886481907938867},"usedName":{"valueName":{"identifier":"setThreadContinue"}},"qualification":null},{"reference":{"builtinModule":"GHC.Types"},"usedName":{"constructorName":{"identifier":"True"},"constructorTypeName":{"identifier":"Bool"}},"qualification":null},{"reference":{"otherSlice":2511855293228854403},"usedName":{"constructorName":{"identifier":"RspnNobody"},"constructorTypeName":{"identifier":"Rspn"}},"qualification":null},{"reference":{"otherSlice":272568700310874138},"usedName":{"constructorName":{"identifier":"Output"},"constructorTypeName":{"identifier":"Output"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"identifier":"return"}},"qualification":null},{"reference":{"otherSlice":2773176672982378577},"usedName":{"constructorName":{"identifier":"ORspn"},"constructorTypeName":{"identifier":"OutputType"}},"qualification":null},{"reference":{"otherSlice":4406646487968172397},"usedName":{"valueName":{"identifier":"enqueueOutput"}},"qualification":null},{"reference":{"otherSlice":1101192067246769824},"usedName":{"constructorName":{"identifier":"ResponseReceived"},"constructorTypeName":{"identifier":"ResponseReceived"}},"qualification":null},{"reference":{"otherSlice":2511855293228854403},"usedName":{"constructorName":{"identifier":"RspnBuilder"},"constructorTypeName":{"identifier":"Rspn"}},"qualification":null},{"reference":{"builtinModule":"Control.Exception.Base"},"usedName":{"valueName":{"identifier":"try"}},"qualification":"E"},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":"$"}},"qualification":null},{"reference":{"otherSlice":27681834806193008},"usedName":{"valueName":{"identifier":"getFileInfo"}},"qualification":null},{"reference":{"builtinModule":"Data.Either"},"usedName":{"constructorName":{"identifier":"Left"},"constructorTypeName":{"identifier":"Either"}},"qualification":null},{"reference":{"builtinModule":"GHC.IO.Exception"},"usedName":{"typeName":{"identifier":"IOException"}},"qualification":"E"},{"reference":{"builtinModule":"Data.Either"},"usedName":{"constructorName":{"identifier":"Right"},"constructorTypeName":{"identifier":"Either"}},"qualification":null},{"reference":{"otherSlice":834453853658109818},"usedName":{"valueName":{"identifier":"conditionalRequest"}},"qualification":null},{"reference":{"otherSlice":6771852686791248122},"usedName":{"constructorName":{"identifier":"WithoutBody"},"constructorTypeName":{"identifier":"RspFileInfo"}},"qualification":null},{"reference":{"otherSlice":6771852686791248122},"usedName":{"constructorName":{"identifier":"WithBody"},"constructorTypeName":{"identifier":"RspFileInfo"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"constructorName":{"identifier":"Just"},"constructorTypeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"otherSlice":94476846762148723},"usedName":{"constructorName":{"identifier":"FilePart"},"constructorTypeName":{"identifier":"FilePart"}},"qualification":null},{"reference":{"otherSlice":4083196669851533839},"usedName":{"valueName":{"identifier":"fileInfoSize"}},"qualification":null},{"reference":{"otherSlice":94476846762148723},"usedName":{"valueName":{"identifier":"filePartByteCount"}},"qualification":null},{"reference":{"builtinModule":"Data.Functor"},"usedName":{"valueName":{"operator":"<$>"}},"qualification":null},{"reference":{"otherSlice":2511855293228854403},"usedName":{"constructorName":{"identifier":"RspnFile"},"constructorTypeName":{"identifier":"Rspn"}},"qualification":null},{"reference":{"otherSlice":1986565597107373991},"usedName":{"valueName":{"identifier":"notFound404"}},"qualification":"H"},{"reference":{"otherSlice":1552621361128324920},"usedName":{"valueName":{"identifier":"replaceHeader"}},"qualification":"R"},{"reference":{"otherSlice":2325900752127330681},"usedName":{"valueName":{"identifier":"hContentType"}},"qualification":"H"},{"reference":{"otherSlice":630697386396126926},"usedName":{"valueName":{"identifier":"byteString"}},"qualification":null},{"reference":{"otherSlice":3179274283845055384},"usedName":{"valueName":{"identifier":"spawnAction"}},"qualification":null},{"reference":{"builtinModule":"GHC.Types"},"usedName":{"constructorName":{"identifier":"False"},"constructorTypeName":{"identifier":"Bool"}},"qualification":null},{"reference":{"otherSlice":4589583230724022993},"usedName":{"valueName":{"identifier":"newTBQueueIO"}},"qualification":null},{"reference":{"otherSlice":2511855293228854403},"usedName":{"constructorName":{"identifier":"RspnStreaming"},"constructorTypeName":{"identifier":"Rspn"}},"qualification":null},{"reference":{"builtinModule":"GHC.Conc.Sync"},"usedName":{"valueName":{"identifier":"atomically"}},"qualification":null},{"reference":{"otherSlice":5581032757464658216},"usedName":{"valueName":{"identifier":"writeTBQueue"}},"qualification":null},{"reference":{"otherSlice":8586306918334549122},"usedName":{"constructorName":{"identifier":"SBuilder"},"constructorTypeName":{"identifier":"Sequence"}},"qualification":null},{"reference":{"otherSlice":1163553957919013733},"usedName":{"valueName":{"identifier":"tickle"}},"qualification":"T"},{"reference":{"otherSlice":8586306918334549122},"usedName":{"constructorName":{"identifier":"SFlush"},"constructorTypeName":{"identifier":"Sequence"}},"qualification":null},{"reference":{"otherSlice":8586306918334549122},"usedName":{"constructorName":{"identifier":"SFinish"},"constructorTypeName":{"identifier":"Sequence"}},"qualification":null},{"reference":{"otherSlice":7860770299146072688},"usedName":{"valueName":{"identifier":"deleteMyId"}},"qualification":null},{"reference":{"otherSlice":7471038449729235448},"usedName":{"typeName":{"identifier":"Settings"}},"qualification":"S"},{"reference":{"otherSlice":3244558403807755735},"usedName":{"typeName":{"identifier":"Context"}},"qualification":null},{"reference":{"otherSlice":546518555448962890},"usedName":{"typeName":{"identifier":"Manager"}},"qualification":null},{"reference":{"otherSlice":3789092878268003829},"usedName":{"typeName":{"identifier":"Responder"}},"qualification":null}],"fragment":["response :: S.Settings -> Context -> Manager -> Responder","response settings ctx@Context{outputQ} mgr ii reqvt tconf strm req\n  rsp\n  = case rsp of\n        ResponseStream s0 hs0 strmbdy | noBody s0 -> responseNoBody s0 hs0\n                                      | isHead -> responseNoBody s0 hs0\n                                      | otherwise ->\n                                        getHTTP2Data req >>=\n                                          pushStream ctx settings sid reqvt req ii\n                                          >>= responseStreaming s0 hs0 strmbdy\n        ResponseBuilder s0 hs0 b | noBody s0 -> responseNoBody s0 hs0\n                                 | isHead -> responseNoBody s0 hs0\n                                 | otherwise ->\n                                   getHTTP2Data req >>= pushStream ctx settings sid reqvt req ii >>=\n                                     responseBuilderBody s0 hs0 b\n        ResponseFile s0 hs0 p mp | noBody s0 -> responseNoBody s0 hs0\n                                 | otherwise ->\n                                   getHTTP2Data req >>= pushStream ctx settings sid reqvt req ii >>=\n                                     responseFileXXX s0 hs0 p mp\n        ResponseRaw _ _ -> error \"HTTP/2 does not support ResponseRaw\"\n  where noBody = not . R.hasBody\n        !isHead = requestMethod req == H.methodHead\n        !logger = S.settingsLogger settings\n        !th = threadHandle ii\n        sid = streamNumber strm\n        !h2data = getHTTP2Data req\n        responseNoBody s hs0 = toHeaderTable hs0 >>= responseNoBody' s\n        responseNoBody' s tbl\n          = do logger req s Nothing\n               setThreadContinue tconf True\n               let !rspn = RspnNobody s tbl\n                   !out = Output strm rspn ii (return ()) h2data ORspn\n               enqueueOutput outputQ out\n               return ResponseReceived\n        responseBuilderBody s hs0 bdy (rspnOrWait, tell)\n          = do logger req s Nothing\n               setThreadContinue tconf True\n               tbl <- toHeaderTable hs0\n               let !rspn = RspnBuilder s tbl bdy\n                   !out = Output strm rspn ii tell h2data rspnOrWait\n               enqueueOutput outputQ out\n               return ResponseReceived\n        responseFileXXX _ hs0 path Nothing aux\n          = do efinfo <- E.try $ getFileInfo ii path\n               case efinfo of\n                   Left (_ex :: E.IOException) -> response404 hs0\n                   Right finfo -> do (rspths0, vt) <- toHeaderTable hs0\n                                     case conditionalRequest finfo rspths0 reqvt of\n                                         WithoutBody s -> responseNoBody s hs0\n                                         WithBody s rspths beg len -> responseFile2XX s (rspths, vt)\n                                                                        path\n                                                                        (Just\n                                                                           (FilePart beg len\n                                                                              (fileInfoSize finfo)))\n                                                                        aux\n        responseFileXXX s0 hs0 path mpart aux\n          = do tbl <- toHeaderTable hs0\n               responseFile2XX s0 tbl path mpart aux\n        responseFile2XX s tbl path mpart (rspnOrWait, tell)\n          | isHead =\n            do logger req s Nothing\n               responseNoBody' s tbl\n          | otherwise =\n            do logger req s (filePartByteCount <$> mpart)\n               setThreadContinue tconf True\n               let !rspn = RspnFile s tbl path mpart\n                   !out = Output strm rspn ii tell h2data rspnOrWait\n               enqueueOutput outputQ out\n               return ResponseReceived\n        response404 hs0 = responseBuilderBody s hs body (ORspn, return ())\n          where s = H.notFound404\n                hs = R.replaceHeader H.hContentType \"text/plain; charset=utf-8\" hs0\n                body = byteString \"File not found\"\n        responseStreaming s0 hs0 strmbdy (rspnOrWait, tell)\n          = do logger req s0 Nothing\n               spawnAction mgr\n               setThreadContinue tconf False\n               tbq <- newTBQueueIO 10\n               tbl <- toHeaderTable hs0\n               let !rspn = RspnStreaming s0 tbl tbq\n                   !out = Output strm rspn ii tell h2data rspnOrWait\n               enqueueOutput outputQ out\n               let push b\n                     = do atomically $ writeTBQueue tbq (SBuilder b)\n                          T.tickle th\n                   flush = atomically $ writeTBQueue tbq SFlush\n               _ <- strmbdy push flush\n               atomically $ writeTBQueue tbq SFinish\n               deleteMyId mgr\n               return ResponseReceived"],"instances":[],"language":{"extensions":["NamedFieldPuns","PatternGuards","ScopedTypeVariables","OverloadedStrings","BangPatterns","MultiParamTypeClasses","NondecreasingIndentation","ExplicitForAll"]}}