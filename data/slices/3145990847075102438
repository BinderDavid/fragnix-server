{"sliceID":3145990847075102438,"uses":[{"reference":{"builtinModule":"GHC.List"},"usedName":{"valueName":{"identifier":"lookup"}},"qualification":null},{"reference":{"otherSlice":2325900752127330681},"usedName":{"valueName":{"identifier":"hContentType"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"constructorName":{"identifier":"Just"},"constructorTypeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"otherSlice":7129769246609355574},"usedName":{"valueName":{"identifier":"gzipCheckMime"}},"qualification":null},{"reference":{"otherSlice":5565122751013001987},"usedName":{"valueName":{"identifier":"fixHeaders"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":"$"}},"qualification":null},{"reference":{"otherSlice":8292802512784632635},"usedName":{"valueName":{"identifier":"responseStream"}},"qualification":null},{"reference":{"otherSlice":5942701355812422116},"usedName":{"valueName":{"identifier":"newBlazeRecv"}},"qualification":"B"},{"reference":{"otherSlice":3273621015017421231},"usedName":{"valueName":{"identifier":"defaultStrategy"}},"qualification":"B"},{"reference":{"otherSlice":4449790253278379577},"usedName":{"valueName":{"identifier":"initDeflate"}},"qualification":"Z"},{"reference":{"otherSlice":3402049011875332117},"usedName":{"constructorName":{"identifier":"WindowBits"},"constructorTypeName":{"identifier":"WindowBits"}},"qualification":"Z"},{"reference":{"builtinModule":"Data.Function"},"usedName":{"valueName":{"identifier":"fix"}},"qualification":null},{"reference":{"builtinModule":"Control.Monad"},"usedName":{"valueName":{"identifier":"unless"}},"qualification":null},{"reference":{"otherSlice":5578418172209195165},"usedName":{"valueName":{"identifier":"null"}},"qualification":"S"},{"reference":{"otherSlice":1841088072525954116},"usedName":{"valueName":{"identifier":"feedDeflate"}},"qualification":"Z"},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":">>="}},"qualification":null},{"reference":{"otherSlice":6119776282763598804},"usedName":{"valueName":{"identifier":"flush"}},"qualification":"Blaze"},{"reference":{"otherSlice":7824374100219563626},"usedName":{"valueName":{"identifier":"flushDeflate"}},"qualification":"Z"},{"reference":{"otherSlice":1496483534253480681},"usedName":{"constructorName":{"identifier":"PRDone"},"constructorTypeName":{"identifier":"PopperRes"}},"qualification":"Z"},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"identifier":"return"}},"qualification":null},{"reference":{"otherSlice":1496483534253480681},"usedName":{"constructorName":{"identifier":"PRNext"},"constructorTypeName":{"identifier":"PopperRes"}},"qualification":"Z"},{"reference":{"otherSlice":6863249147699497121},"usedName":{"valueName":{"identifier":"fromByteString"}},"qualification":null},{"reference":{"otherSlice":1496483534253480681},"usedName":{"constructorName":{"identifier":"PRError"},"constructorTypeName":{"identifier":"PopperRes"}},"qualification":"Z"},{"reference":{"builtinModule":"GHC.IO"},"usedName":{"valueName":{"identifier":"throwIO"}},"qualification":null},{"reference":{"otherSlice":1442496035407045144},"usedName":{"valueName":{"identifier":"finishDeflate"}},"qualification":"Z"},{"reference":{"otherSlice":151727817086787467},"usedName":{"valueName":{"identifier":"responseToStream"}},"qualification":null},{"reference":{"otherSlice":7129769246609355574},"usedName":{"typeName":{"identifier":"GzipSettings"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"typeName":{"identifier":"Response"}},"qualification":null},{"reference":{"builtinModule":"GHC.Types"},"usedName":{"typeName":{"identifier":"IO"}},"qualification":null}],"fragment":["compressE :: GzipSettings -> Response -> (Response -> IO a) -> IO a","compressE set res sendResponse\n  = case lookup hContentType hs of\n        Just m | gzipCheckMime set m ->\n                 let hs' = fixHeaders hs in\n                   wb $\n                     \\ body ->\n                       sendResponse $\n                         responseStream s hs' $\n                           \\ sendChunk flush ->\n                             do (blazeRecv, _) <- B.newBlazeRecv B.defaultStrategy\n                                deflate <- Z.initDeflate 1 (Z.WindowBits 31)\n                                let sendBuilder builder\n                                      = do popper <- blazeRecv builder\n                                           fix $\n                                             \\ loop ->\n                                               do bs <- popper\n                                                  unless (S.null bs) $\n                                                    do sendBS bs\n                                                       loop\n                                    sendBS bs = Z.feedDeflate deflate bs >>= deflatePopper\n                                    flushBuilder\n                                      = do sendBuilder Blaze.flush\n                                           deflatePopper $ Z.flushDeflate deflate\n                                           flush\n                                    deflatePopper popper\n                                      = fix $\n                                          \\ loop ->\n                                            do result <- popper\n                                               case result of\n                                                   Z.PRDone -> return ()\n                                                   Z.PRNext bs' -> do sendChunk $ fromByteString bs'\n                                                                      loop\n                                                   Z.PRError e -> throwIO e\n                                body sendBuilder flushBuilder\n                                sendBuilder Blaze.flush\n                                deflatePopper $ Z.finishDeflate deflate\n        _ -> sendResponse res\n  where (s, hs, wb) = responseToStream res"],"instances":[],"language":{"extensions":["OverloadedStrings","Rank2Types","ScopedTypeVariables","MultiParamTypeClasses","NondecreasingIndentation","ExplicitForAll","PatternGuards"]}}