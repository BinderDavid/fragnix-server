{"sliceID":8821425206594215095,"uses":[{"reference":{"builtinModule":"Data.Maybe"},"usedName":{"valueName":{"identifier":"fromMaybe"}},"qualification":null},{"reference":{"otherSlice":4791260247128078865},"usedName":{"valueName":{"identifier":"empty"}},"qualification":"B8"},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"operator":"$"}},"qualification":null},{"reference":{"builtinModule":"GHC.List"},"usedName":{"valueName":{"identifier":"lookup"}},"qualification":null},{"reference":{"otherSlice":2325900752127330681},"usedName":{"valueName":{"identifier":"hAccept"}},"qualification":null},{"reference":{"otherSlice":2150836866812832620},"usedName":{"valueName":{"identifier":"requestHeaders"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"typeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"otherSlice":4942888801223460576},"usedName":{"typeName":{"identifier":"ByteString"}},"qualification":"B8"},{"reference":{"otherSlice":4266482746038848749},"usedName":{"valueName":{"identifier":"pack"}},"qualification":"B8"},{"reference":{"otherSlice":8153825048320937403},"usedName":{"valueName":{"identifier":"isInfixOf"}},"qualification":"B8"},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"identifier":"join"}},"qualification":null},{"reference":{"otherSlice":2150836866812832620},"usedName":{"valueName":{"identifier":"queryString"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"constructorName":{"identifier":"Nothing"},"constructorTypeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"constructorName":{"identifier":"Just"},"constructorTypeName":{"identifier":"Maybe"}},"qualification":null},{"reference":{"otherSlice":8171696754123102574},"usedName":{"valueName":{"identifier":"changeVal"}},"qualification":null},{"reference":{"otherSlice":8218805848122191995},"usedName":{"constructorName":{"identifier":"ResponseBuilder"},"constructorTypeName":{"identifier":"Response"}},"qualification":null},{"reference":{"otherSlice":1449356264122510486},"usedName":{"valueName":{"identifier":"responseBuilder"}},"qualification":null},{"reference":{"otherSlice":773656825116951878},"usedName":{"valueName":{"identifier":"copyByteString"}},"qualification":null},{"reference":{"builtinModule":"GHC.Base"},"usedName":{"valueName":{"identifier":"mappend"}},"qualification":null},{"reference":{"otherSlice":3564279037948798687},"usedName":{"valueName":{"identifier":"fromChar"}},"qualification":null},{"reference":{"otherSlice":151727817086787467},"usedName":{"valueName":{"identifier":"responseToStream"}},"qualification":null},{"reference":{"otherSlice":2325900752127330681},"usedName":{"valueName":{"identifier":"hContentType"}},"qualification":null},{"reference":{"otherSlice":404915850270007730},"usedName":{"valueName":{"identifier":"isPrefixOf"}},"qualification":"S"},{"reference":{"otherSlice":8292802512784632635},"usedName":{"valueName":{"identifier":"responseStream"}},"qualification":null},{"reference":{"otherSlice":8780573258186764165},"usedName":{"typeName":{"identifier":"Middleware"}},"qualification":null}],"fragment":["jsonp :: Middleware","jsonp app env sendResponse\n  = do let accept\n             = fromMaybe B8.empty $ lookup hAccept $ requestHeaders env\n       let callback :: Maybe B8.ByteString\n           callback\n             = if B8.pack \"text/javascript\" `B8.isInfixOf` accept then\n                 join $ lookup \"callback\" $ queryString env else Nothing\n       let env'\n             = case callback of\n                   Nothing -> env\n                   Just _ -> env{requestHeaders =\n                                   changeVal hAccept \"application/json\" $ requestHeaders env}\n       app env' $\n         \\ res ->\n           case callback of\n               Nothing -> sendResponse res\n               Just c -> go c res\n  where go c r@(ResponseBuilder s hs b)\n          = sendResponse $\n              case checkJSON hs of\n                  Nothing -> r\n                  Just hs' -> responseBuilder s hs' $\n                                copyByteString c `mappend` fromChar '(' `mappend` b `mappend`\n                                  fromChar ')'\n        go c r\n          = case checkJSON hs of\n                Just hs' -> addCallback c s hs' wb\n                Nothing -> sendResponse r\n          where (s, hs, wb) = responseToStream r\n        checkJSON hs\n          = case lookup hContentType hs of\n                Just x | B8.pack \"application/json\" `S.isPrefixOf` x ->\n                         Just $ fixHeaders hs\n                _ -> Nothing\n        fixHeaders = changeVal hContentType \"text/javascript\"\n        addCallback cb s hs wb\n          = wb $\n              \\ body ->\n                sendResponse $\n                  responseStream s hs $\n                    \\ sendChunk flush ->\n                      do sendChunk $ copyByteString cb `mappend` fromChar '('\n                         _ <- body sendChunk flush\n                         sendChunk $ fromChar ')'"],"instances":[],"language":{"extensions":["OverloadedStrings","RankNTypes","MultiParamTypeClasses","NondecreasingIndentation","ExplicitForAll","PatternGuards"]}}